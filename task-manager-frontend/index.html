<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Manager Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #output { margin-top: 15px; padding: 10px; border: 1px solid #ccc; min-height: 50px; }
        button { margin-right: 10px; padding: 5px 10px; }
    </style>
</head>
<body>
<h1>Task Manager Demo</h1>
<h2>Login</h2>
<div style="display:flex;justify-content: flex-start;gap:1.5em;">
<button id="loginBtn">Login</button>
<button id="logoutBtn">Logout</button>
</div>
<br><br>
<h2>Find groups</h2>
<div id="output"></div>
<br>
<button id="fetchBtn">Fetch Groups</button>
<button id="clearBtn">Clear</button>
<br><br>
<h2>Create a group</h2>
<form id="createGroupForm">
    <div style="display:flex;justify-content: flex-start;gap:1.5em;">
    <label>Title: <input type="text" name="name" required></label><br><br>
    <label>Description: <input type="text" name="description" required></label><br><br>
    </div>
    <br><br>
    <button id="createGroupBtn" type="submit">Create</button>
</form>
<br><br>

<h2>Patch Group</h2>
<form id="updateGroupForm">
    <div style="display:flex;justify-content: flex-start;gap:1.5em;">
    <label>Group ID: <input type="number" name="groupId" required></label><br><br>
    <label>New Name: <input type="text" name="name"></label><br><br>
    <label>New Description: <input type="text" name="description"></label><br><br>
    </div>
    <br><br>
    <button type="submit">Patch Group</button>
</form>
<br><br>

<h2>Delete Group</h2>
<form id="deleteGroupForm">
    <label>Group ID: <input type="number" name="groupId" required></label>
    <br><br>
    <button type="submit">Delete Group</button>
</form>

<br><br>
<h2>Create a Task</h2>

<form id="createTaskForm">

    <div style="display:flex; gap:1.5em;">
        <label>
            Group ID:
            <input type="number" id="groupIdInput" value="1" required>
        </label>

        <label>
            Title:
            <input type="text" name="title" required>
        </label>

        <label>
            Description:
            <input type="text" name="description" required>
        </label>
    </div>

    <br>

    <div style="display:flex; gap:1.5em;">
        <label>
            Task State:
            <select name="taskState">
                <option value="TODO">TODO</option>
                <option value="IN_PROGRESS">IN_PROGRESS</option>
                <option value="DONE">DONE</option>
            </select>
        </label>
    </div>

    <br>

    <div>
        <strong>Assignees</strong>
        <div id="assignees">
            <input type="number" name="assignedIds" placeholder="User ID">
        </div>
        <button type="button" id="addAssignee">+</button>
    </div>

    <br>

    <div>
        <strong>Reviewers</strong>
        <div id="reviewers">
            <input type="number" name="reviewerIds" placeholder="User ID">
        </div>
        <button type="button" id="addReviewer">+</button>
    </div>

    <br>

    <label>
        Files:
        <input type="file" name="files" multiple>
    </label>

    <br><br>

    <button type="submit">Create Task</button>
</form>


<br><br>
<h2>Patch a Task</h2>
<form id="patchTaskForm">
    <label>
        GroupId:
        <input type="number" name="groupId">
    </label>
    <label>
        TaskId:
        <input type="number" name="taskId">
    </label>
    <label>
        Title:
    <input type="text" name="title">
    </label>
    <label>
        Description:
        <input type="text" name="description">
    </label>
    <label>
        TaskState:
        <select name="taskState">
            <option value="" selected>Empty</option>
            <option value="TODO">TODO</option>
            <option value="IN_PROGRESS">IN_PROGRESS</option>
            <option value="TO_BE_REVIEWED">TO_BE_REVIEWED</option>
            <option value="DONE">DONE</option>

        </select>
    </label>
    <button type="submit" id="patchTaskBtn">PatchTask</button>
</form>
<script>

    // LOGIN
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.addEventListener('click', () => {
        fetch('/api/auth/login-url')
            .then(res => res.text())
            .then(url => {
                window.location.href = url;   // redirect to Azure AD
            });
    });

    // LOGOUT
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
        fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
            .then(response => {
                if (response.ok) {
                    outputDiv.innerHTML = 'Logged out successfully.';

                    window.location.reload();
                } else {
                    outputDiv.innerHTML = 'Logout failed.';
                }
            })
            .catch(err => {
                outputDiv.innerHTML = 'Error: ' + err.message;
            });
    });

    //FIND GROUPS OF LOGGED IN USER
    const fetchBtn = document.getElementById('fetchBtn');
    const outputDiv = document.getElementById('output');
    fetchBtn.addEventListener('click', () => {
        fetch('/api/groups')
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                outputDiv.innerHTML = JSON.stringify(data, null, 2);
            })
            .catch(err => {
                outputDiv.innerHTML = 'Error: ' + err.message;
            });
    });

    //CLEAR RESULTS OF GROUPS OF LOGGED IN USER
    const clearBtn = document.getElementById('clearBtn');
    clearBtn.addEventListener('click', () => {
        outputDiv.innerHTML = '';
    });

    //CREATE GROUP
    const groupFormBtn = document.querySelector("#createGroupBtn");
    const groupForm = document.querySelector("#createGroupForm");
    groupFormBtn.addEventListener('click',async (event)=>{
        event.preventDefault();
        const json =JSON.stringify(Object.fromEntries(new FormData(groupForm).entries()));
        const res = await fetch('/api/groups',{
            method:'POST',
            headers:{
                "Content-Type":"application/json"
            },
            body:json
        })
        if (res.ok){
            const result = await res.json()
            console.log("Group created",result)
        }else{
            console.error("Failed to create group:", res.status);
        }
    });

    // PATCH GROUP
    const updateGroupForm = document.getElementById("updateGroupForm");
    updateGroupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(new FormData(updateGroupForm).entries());
        const groupId = formData.groupId;
        delete formData.groupId; // remove ID from payload

        try {
            const res = await fetch(`/api/groups/${groupId}`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData)
            });

            if (res.ok) {
                const result = await res.json();
                alert("Group patched: " + JSON.stringify(result, null, 2));
            } else {
                alert("Failed to patch group: " + res.status);
            }
        } catch (err) {
            alert("Error: " + err.message);
        }
    });

    //DELETE GROUP
    const deleteGroupForm = document.getElementById("deleteGroupForm");
    deleteGroupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const groupId = deleteGroupForm.groupId.value;

        try {
            const res = await fetch(`/api/groups/${groupId}`, { method: "DELETE" });

            if (res.ok) {
                alert(`Group ${groupId} deleted successfully.`);
            } else {
                alert("Failed to delete group: " + res.status);
            }
        } catch (err) {
            alert("Error: " + err.message);
        }
    });



    const createTaskForm = document.getElementById("createTaskForm");


    document.getElementById("addAssignee").addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "number";
        input.name = "assignedIds";
        input.placeholder = "User ID";
        document.getElementById("assignees").appendChild(input);
    });


    document.getElementById("addReviewer").addEventListener("click", () => {
        const input = document.createElement("input");
        input.type = "number";
        input.name = "reviewerIds";
        input.placeholder = "User ID";
        document.getElementById("reviewers").appendChild(input);
    });

    createTaskForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const groupId = document.getElementById("groupIdInput").value;
        const formData = new FormData();
        const taskJson = {
            assignedIds: [],
            reviewerIds: []
        };

        for (const [key, value] of new FormData(createTaskForm).entries()) {
            if (!value) continue;

            if (key === "assignedIds") {
                taskJson.assignedIds.push(Number(value));
            } else if (key === "reviewerIds") {
                taskJson.reviewerIds.push(Number(value));
            } else if (key !== "files") {
                taskJson[key] = value;
            }
        }

        formData.append(
            "data",
            new Blob([JSON.stringify(taskJson)], { type: "application/json" })
        );

        const fileInput = createTaskForm.querySelector('input[name="files"]');
        for (const file of fileInput.files) {
            formData.append("files", file, file.name);
        }

        try {
            const res = await fetch(`/api/groups/${groupId}/tasks`, {
                method: "POST",
                body: formData
            });

            if (res.ok) {
                const result = await res.json();
                alert("Task created:" + JSON.stringify(result));
            } else {
                console.error("Failed to create task", res.status);
            }
        } catch (err) {
            console.error("Error:", err);
        }
    });

    //Patch Task
    const patchForm = document.getElementById("patchTaskForm");
    const formDataToBeSend = new FormData();
    document.getElementById("patchTaskBtn").addEventListener("click",
       async (e) =>{
        e.preventDefault();
            for ( [key,value] of new FormData(patchForm).entries() ){
                if(value && value.trim() !== ""){
                    formDataToBeSend.append(key,value);
                }
            }
            if (!(formDataToBeSend.has("groupId") && formDataToBeSend.has("taskId"))){
                return alert("requires group and task id");
            }
            let groupId = formDataToBeSend.get("groupId");
            let taskId = formDataToBeSend.get("taskId");

            const res = await fetch(`api/groups/${groupId}/task/${taskId}`,
                {
                    method :"PATCH",
                    headers: { "Content-Type":"application/json"},
                    body :JSON.stringify( Object.fromEntries(formDataToBeSend.entries()))
                }
            )

           if (res.ok) {
               const result = await res.json();
               alert("Task patched:" + JSON.stringify(result));
           } else {
               console.error("Failed to patch task", res.status);
           }

        } ) ;


</script>
</body>
</html>
