<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Manager Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #output { margin-top: 15px; padding: 10px; border: 1px solid #ccc; min-height: 50px; }
        button { margin-right: 10px; padding: 5px 10px; }
    </style>
</head>
<body>
<h1>Task Manager Demo</h1>
<button id="fetchBtn">Fetch Groups</button>
<button id="clearBtn">Clear</button>

<div id="output"></div>

<h2>Create a group</h2>
<form id="createGroupForm">
    <label>Title: <input type="text" name="name" required></label><br><br>
    <label>Description: <input type="text" name="description" required></label><br><br>
    <button id="createGroupBtn" type="submit">Create</button>
</form>
<br><br>

<h2>Create a Task</h2>
<form id="createTaskForm">
    <label>Group ID: <input type="number" id="groupIdInput" value="1" required></label><br><br>
    <label>Title: <input type="text" name="title" required></label><br><br>
    <label>Description: <input type="text" name="description" required></label><br><br>
    <label>Task State:
        <select name="taskState">
            <option value="TODO">TODO</option>
            <option value="IN_PROGRESS">IN_PROGRESS</option>
            <option value="DONE">DONE</option>
        </select>
    </label><br><br>
    <label>Assigned User ID: <input type="number" name="assignedId"></label><br><br>
    <label>Reviewer User ID: <input type="number" name="reviewerId"></label><br><br>
    <label>File: <input type="file" name="file"></label><br><br>
    <button type="submit">Create Task</button>
</form>

<br><br>
<button id="loginBtn">Login</button>
<br><br>
<button id="logoutBtn">Logout</button>
<script>
    const fetchBtn = document.getElementById('fetchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const outputDiv = document.getElementById('output');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const groupFormBtn = document.querySelector("#createGroupBtn");
    const groupForm = document.querySelector("#createGroupForm");

    groupFormBtn.addEventListener('click',async (event)=>{
        event.preventDefault();
        const json =JSON.stringify(Object.fromEntries(new FormData(groupForm).entries()));
        const res = await fetch('/api/groups',{
            method:'POST',
            headers:{
                "Content-Type":"application/json"
            },
            body:json
        })
        if (res.ok){
            const result = await res.json()
            console.log("Group created",result)
        }else{
            console.error("Failed to create group:", res.status);
        }
    })

    loginBtn.addEventListener('click', () => {
        fetch('/api/auth/login-url')
            .then(res => res.text())
            .then(url => {
                window.location.href = url;   // redirect to Azure AD
            });
    });

    logoutBtn.addEventListener('click', () => {
        fetch('/api/auth/logout', { method: 'POST', credentials: 'include' })
            .then(response => {
                if (response.ok) {
                    outputDiv.innerHTML = 'Logged out successfully.';

                    window.location.reload();
                } else {
                    outputDiv.innerHTML = 'Logout failed.';
                }
            })
            .catch(err => {
                outputDiv.innerHTML = 'Error: ' + err.message;
            });
    });


    fetchBtn.addEventListener('click', () => {
        fetch('/api/groups')
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                outputDiv.innerHTML = JSON.stringify(data, null, 2);
            })
            .catch(err => {
                outputDiv.innerHTML = 'Error: ' + err.message;
            });
    });

    clearBtn.addEventListener('click', () => {
        outputDiv.innerHTML = '';
    });




    const createTaskForm = document.getElementById("createTaskForm");

    createTaskForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const groupId = document.getElementById("groupIdInput").value; // dynamically fetch groupId
        const formData = new FormData();
        const taskJson = {};

        for (const [key, value] of new FormData(createTaskForm).entries()) {
            if (key !== "file" && key !== "groupId") taskJson[key] = value;
        }

        formData.append("data", new Blob([JSON.stringify(taskJson)], { type: "application/json" }));

        const fileInput = createTaskForm.querySelector('input[name="file"]');
        if (fileInput.files.length > 0) {
            formData.append("file", fileInput.files[0]);
        }

        try {
            const res = await fetch(`/api/groups/${groupId}/tasks`, {
                method: "POST",
                body: formData
            });

            if (res.ok) {
                const result = await res.json();
                console.log("Task created:", result);
                alert("Task created: " + JSON.stringify(result, null, 2));
            } else {
                console.error("Failed to create task", res.status);
            }
        } catch (err) {
            console.error("Error:", err);
        }
    });

</script>
</body>
</html>
